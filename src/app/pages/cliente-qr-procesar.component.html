<section class="container py-3">
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h5 mb-3">Procesamiento de QR</h2>
      <p class="text-muted mb-3">ID recibido: <strong>{{ idCliente ?? 'Sin datos' }}</strong></p>

      <div *ngIf="isLoading" class="alert alert-info">Cargando cliente...</div>
      <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

      <div *ngIf="cliente" class="mt-2">
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between">
            <span>ID</span>
            <strong>{{ cliente.id }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Nombre</span>
            <strong>{{ cliente.nombre }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Email</span>
            <strong>{{ cliente.email }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Empresa</span>
            <strong>{{ cliente.empresa }}</strong>
          </li>
        </ul>
      </div>

      <hr class="my-4" />

      <h3 *ngIf="remisionSurtir.length > 0" class="h6 mb-3">Remisiones por surtir</h3>
      <div *ngIf="remisionSurtirLoading" class="alert alert-info">Cargando remisiones...</div>
      <div *ngIf="remisionSurtirError" class="alert alert-danger">{{ remisionSurtirError }}</div>
      <div *ngIf="surtirError" class="alert alert-danger">{{ surtirError }}</div>
      <div *ngIf="surtirSuccess" class="alert alert-success">{{ surtirSuccess }}</div>

      <div *ngIf="remisionSurtir.length > 0">
        <div *ngFor="let remision of remisionSurtir" class="card mb-3">
          <div class="card-header d-flex flex-wrap gap-3 align-items-center">
            <span class="fw-semibold">Remision #{{ remision.id }}</span>
            <span class="text-muted">Pedido: {{ remision.id_pedido }}</span>
            <span class="text-muted">Estatus: {{ remision.estatus_remision }}</span>
            <span class="text-muted">Resurtido: {{ remision.estatus_resurtida }}</span>
          </div>
          <div class="card-body">
            <div *ngIf="remision.detalles.length === 0" class="text-muted">Sin detalles.</div>

            <div *ngFor="let detalle of remision.detalles" class="border rounded p-3 mb-3">
              <div class="d-flex flex-wrap gap-3 align-items-start">
                <div class="row">
                  <div class="col-4">
                    <div *ngIf="detalle.inventario.imagen; else noInventarioImagen" class="product-image-wrapper">
                      <img
                        [src]="getImagenUrl(detalle.inventario.imagen)"
                        [alt]="'Inventario ' + detalle.inventario.id"
                        class="product-image"
                      />
                    </div>
                    <ng-template #noInventarioImagen>
                      <div class="product-image-wrapper product-image-placeholder">
                        <span>Sin imagen</span>
                      </div>
                    </ng-template>
                  </div>
                  <div class="col-8">
                    <div><strong>Inventario:</strong> {{ detalle.id_inventario }}</div>
                    <div><strong>Color:</strong> {{ detalle.inventario.color }}</div>
                    <div><strong>Cantidad:</strong> {{ detalle.cantidad }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-center mt-3">
          <button
            type="button"
            class="btn btn-primary"
            [disabled]="surtirLoading"
            (click)="openSurtirConfirm()"
          >
            Surtir mercancia
          </button>
        </div>
      </div>

      <div *ngIf="remisionSurtir.length === 0">
        <h3 class="h6 mb-3">Pedidos del cliente</h3>
        <div *ngIf="pedidosLoading" class="alert alert-info">Cargando pedidos...</div>
        <div *ngIf="pedidosError" class="alert alert-danger">{{ pedidosError }}</div>
        <div *ngIf="entregaError" class="alert alert-danger">{{ entregaError }}</div>
        <div *ngIf="entregaSuccess" class="alert alert-success">{{ entregaSuccess }}</div>

        <div *ngIf="!pedidosLoading && !pedidosError && pedidos.length === 0" class="alert alert-secondary">
          No hay pedidos para este cliente.
        </div>

        <div *ngFor="let pedido of pedidos" class="card mb-3">
          <div class="card-header d-flex flex-wrap gap-3 align-items-center">
            <span class="fw-semibold">Pedido #{{ pedido.id }}</span>
            <span class="ms-auto"></span>
          </div>
          <div class="card-body">
            <div *ngIf="signatureDataUrl[pedido.id]" class="mb-3">
              <span class="text-success small d-block mb-2">Firma capturada</span>
              <img [src]="signatureDataUrl[pedido.id]" alt="Firma" class="signature-preview" />
            </div>
            <div *ngIf="pedido.detalles.length === 0" class="text-muted">Sin detalles.</div>

            <div *ngFor="let detalle of pedido.detalles" class="border rounded p-3 mb-3">
              <div class="d-flex flex-wrap gap-3 align-items-start">
                <div class="row">
                  <div class="col-4">
                    <div *ngIf="detalle.imagen; else noImagen" class="product-image-wrapper">
                      <img [src]="getImagenUrl(detalle.imagen)" [alt]="'Producto ' + detalle.clave"
                        class="product-image" />
                    </div>
                    <ng-template #noImagen>
                      <div class="product-image-wrapper product-image-placeholder">
                        <span>Sin imagen</span>
                      </div>
                    </ng-template>
                  </div>
                  <div class="col-8">
                    <div><strong>Clave:</strong> {{ detalle.clave }}</div>
                    <div><strong>Color:</strong> {{ detalle.color_producto }}</div>
                    <div><strong>Cant. entrega:</strong> {{ detalle.cantidad_remisionada }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-center mt-4">
          <button type="button" class="btn btn-success px-4" (click)="startEntrega()" [disabled]="pedidos.length === 0">
            Entregar mercancía
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<div *ngIf="signatureModalOpen" class="modal fade show d-block" tabindex="-1" aria-modal="true" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Firma de entrega</h5>
        <button type="button" class="btn-close" aria-label="Cerrar" (click)="closeSignatureModal()"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-2">Firme en el área para confirmar la entrega.</p>
        <div class="signature-pad border rounded bg-light">
          <canvas #signatureCanvas (pointerdown)="startDraw($event)" (pointermove)="draw($event)"
            (pointerup)="endDraw()" (pointerleave)="endDraw()"></canvas>
        </div>
        <div class="mt-3">
          <label class="form-label">Fotografia (opcional)</label>
          <input type="file" class="form-control" accept="image/*" capture="environment"
            (change)="onPhotoSelected($event)" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="clearSignature()">
          Limpiar
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeSignatureModal()">
          Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="saveSignature()" [disabled]="entregaSubmitting">
          Guardar firma
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="signatureModalOpen" class="modal-backdrop fade show"></div>

<app-confirm-modal
  [open]="surtirConfirmOpen"
  title="Confirmar surtido"
  message="¿Deseas surtir la mercancia ahora?"
  confirmText="Confirmar"
  cancelText="Cancelar"
  [confirmDisabled]="surtirLoading"
  (confirm)="confirmSurtirMercancia()"
  (cancel)="closeSurtirConfirm()"
></app-confirm-modal>